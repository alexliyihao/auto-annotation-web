{% load static %}
<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="utf-8">
    <title>Imageview: {{image.image_name}} - AAAP</title>
    <!-- website css -->
    <link rel="stylesheet" type="text/css" href="{% static 'annotations/style.css' %}">
    <!-- OpenSeaDragon Annotorious css -->
    <link rel="stylesheet" href="{% static 'annotations/annotorious.min.css' %}">
    <!-- OpenSeaDragon -->
    <script src="{% static 'annotations/openseadragon/openseadragon.min.js' %}"></script>
    <!-- OpenSeaDragon Annotorious JS -->
    <script src="{% static 'annotations/openseadragon-annotorious.min.js' %}"></script>
    <!-- Annotorious Toolbar Plugin -->
    <script src="{% static 'annotations/annotorious-toolbar.min.js' %}"></script>
</head>


<body>
  <div class='title'>
    <h1>Imageview: {{image.image_name}}</h1>
    <a class='return' href="{% url 'annotations:image-list' %}">Return to image list</a>
  <!-- this div is used for debugging, meanwhile tracking the mouse-->
  <div class="info" style="position: fixed; top: 0px; left:400px; width: 800px; height:200px">
      <div class="position"></div>
      <div class="zoom" style="margin-top: 1em;"></div>
  </div>
  </div>
  <div id="annotorious-toolbar" style="position:fixed;top:10%"></div>
  <!-- the div openseadragon-div will take over the whole page -->
  <div id="openseadragon-div"></div>
  <!-- scripts -->

  <script type="text/javascript">
      // For the coordinate display
      var positionEl = document.querySelectorAll('.info .position')[0];
      var zoomEl = document.querySelectorAll('.info .zoom')[0];

      // Main OpenSeaDragon viewer
      var viewer = OpenSeadragon({
          id: "openseadragon-div",
          showNavigator:  true,
          prefixUrl: "{% static 'annotations/openseadragon/images/' %}",
          //this tileSources is only for debugging mode -- to be corrected
          tileSources:[ "{{filepath}}{{image_path}}"]
      });

      // OpenSeaDragon.Annotorious config
      const config = {
          allowEmpty:false,
          gigapixelMode:true,
          widgets: [
              'COMMENT'
          ]
      };

      //register the viewer and the configuration to Annotorious
      var anno = OpenSeadragon.Annotorious(viewer, config);

      //set the drawing tool to polygon (rect doesn't make much sense here)
      anno.setDrawingTool(toolName = 'polygon');
      
      //add a toolbar to the openseadragon viewer
      Annotorious.Toolbar(anno, document.getElementById('annotorious-toolbar'));

      // The followings are the update function of coordinate tracing element
      var updateZoom = function() {
          var zoom = viewer.viewport.getZoom(true);
          var imageZoom = viewer.viewport.viewportToImageZoom(zoom);

          zoomEl.innerHTML = 'Zoom:' + (Math.round(zoom * 100) / 100) +
              ' Image Zoom:' + (Math.round(imageZoom * 100) / 100);
      }

      viewer.addHandler('open', function() {

          var tracker = new OpenSeadragon.MouseTracker({
              element: viewer.container,
              moveHandler: function(event) {
                  var webPoint = event.position;
                  var viewportPoint = viewer.viewport.pointFromPixel(webPoint);
                  var imagePoint = viewer.viewport.viewportToImageCoordinates(viewportPoint);
                  var zoom = viewer.viewport.getZoom(true);
                  var imageZoom = viewer.viewport.viewportToImageZoom(zoom);

                  positionEl.innerHTML = 'Web:' + webPoint.toString() +
                      ' Viewport:' + viewportPoint.toString() +
                      ' Image:' + imagePoint.toString();

                  updateZoom();
              }
          });

          tracker.setTracking(true);

          viewer.addHandler('animation', updateZoom);
      });
  </script>
</body>
</html>
